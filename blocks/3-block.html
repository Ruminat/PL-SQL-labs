<!DOCTYPE htmls>
<html lang="ru">
  <head>
    <title>PL/SQL Лабы. Блок 3</title>
    <meta charset="UTF-8"/>
    <link rel="icon" href="./../img/icons/database.png"/>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"/>
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css" integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf" crossorigin="anonymous"/>
    <link rel="stylesheet" href="./../css/main.css"/>
  </head>
  <body>
    <nav id="menu"><a class="element" id="menu-switch">
        <div class="icon-part"><img class="icon" src="../img/icons/menu.png"/></div>
        <div class="text-part"></div></a><a class="element" href="../index.html">
        <div class="icon-part"><img class="icon" src="../img/icons/home.png"/></div>
        <div class="text-part">На главную</div></a><a class="element link" href="https://github.com/Ruminat/PL-SQL-labs">
        <div class="icon-part"><img class="icon" src="../img/icons/github.png"/></div>
        <div class="text-part">GitHub</div></a><a class="element" href="#lab-9">
        <div class="icon-part">9.</div>
        <div class="text-part">лабораторная</div></a><a class="element sub" id="contents-task-9-1" href="#task-9-1">
        <div class="icon-part">1.</div>
        <div class="text-part">задание</div></a><a class="element sub" id="contents-task-9-2" href="#task-9-2">
        <div class="icon-part">2.</div>
        <div class="text-part">задание</div></a><a class="element sub" id="contents-task-9-3" href="#task-9-3">
        <div class="icon-part">3.</div>
        <div class="text-part">задание</div></a><a class="element sub" id="contents-task-9-4" href="#task-9-4">
        <div class="icon-part">4.</div>
        <div class="text-part">задание</div></a><a class="element" href="#lab-10">
        <div class="icon-part">10.</div>
        <div class="text-part">лабораторная</div></a><a class="element sub" id="contents-task-10-1" href="#task-10-1">
        <div class="icon-part">1.</div>
        <div class="text-part">задание</div></a><a class="element sub" id="contents-task-10-2" href="#task-10-2">
        <div class="icon-part">2.</div>
        <div class="text-part">задание</div></a><a class="element sub" id="contents-task-10-3" href="#task-10-3">
        <div class="icon-part">3.</div>
        <div class="text-part">задание</div></a><a class="element" href="#lab-12">
        <div class="icon-part">12.</div>
        <div class="text-part">лабораторная</div></a><a class="element sub" id="contents-task-12-1" href="#task-12-1">
        <div class="icon-part">1.</div>
        <div class="text-part">задание</div></a><a class="element sub" id="contents-task-12-2" href="#task-12-2">
        <div class="icon-part">2.</div>
        <div class="text-part">задание</div></a><a class="element" href="#lab-13">
        <div class="icon-part">13.</div>
        <div class="text-part">лабораторная</div></a><a class="element sub" id="contents-task-13-1" href="#task-13-1">
        <div class="icon-part">1.</div>
        <div class="text-part">задание</div></a><a class="element sub" id="contents-task-13-2" href="#task-13-2">
        <div class="icon-part">2.</div>
        <div class="text-part">задание</div></a><a class="element sub" id="contents-task-13-3" href="#task-13-3">
        <div class="icon-part">3.</div>
        <div class="text-part">задание</div></a><a class="element sub" id="contents-task-13-4" href="#task-13-4">
        <div class="icon-part">4.</div>
        <div class="text-part">задание</div></a><a class="element sub" id="contents-task-13-5" href="#task-13-5">
        <div class="icon-part">5.</div>
        <div class="text-part">задание</div></a>
    </nav>
    <div id="main">
      <div class="labs">
        <div class="header">
          <h2>Третий Блок</h2>
        </div>
        <div class="lab" id="lab-9"><a name="#lab-9">
            <h4>Практическое занятие 9. Создание процедур</h4></a>
          <ul>
            <li>Создание процедур. </li>
            <li>Режимы параметров.</li>
          </ul>
          <div class="task" id="task-9-1">
            <p class="task-text" name="task-9-1"><b>Задание 1.</b> Создайте процедуру <code>add_job</code> для добавления записей в таблицу <code>Jobs</code>.</p>
            <ul>
              <li>Процедура должна принимать на вход 2 параметра — <code>id</code> и <code>job_title</code>.</li>
              <li>Запустите процедуру на исполнение с помощью анонимного блока или инструкции <code>EXECUTE</code>. Протестируйте работу на примере следующих значений, зафиксируйте и объясните результат:</li>
              <ul>
                <li><code>IT_DBA</code> и <code>Database Administrator</code>.</li>
              </ul>
              <li>Запустите процедуру на исполнение с помощью анонимного блока или инструкции <code>EXECUTE</code>. Протестируйте работу на примере следующих значений, зафиксируйте и объясните результат:</li>
              <ul>
                <li><code>ST_MAN</code> и <code>Stock Manager</code>.</li>
              </ul>
            </ul>
            <pre class="line-numbers undefined"><code class="language-plsql">CREATE OR REPLACE PROCEDURE
  add_job (id Jobs.Job_ID%TYPE, job_title Jobs.Job_Title%TYPE) IS
BEGIN
  INSERT INTO Jobs (Job_ID, Job_Title)
  VALUES           (id,     job_title);
END add_job;</code></pre>
            <pre><code class="language-output">
                Procedure ADD_JOB compiled
                </code></pre>
            <pre class="line-numbers undefined"><code class="language-plsql">EXECUTE add_job('IT_DBA', 'Database Administrator')</code></pre>
            <pre><code class="language-output">PL/SQL procedure successfully completed.</code></pre>
            <p>Всё прошло успешно, так как в таблице <code>Jobs</code> нет записи с ключом <code>IT_DBA</code>.</p>
            <pre class="line-numbers undefined"><code class="language-plsql">EXECUTE add_job('ST_MAN', 'Stock Manager')</code></pre>
            <pre><code class="language-output">
                Error starting at line : 1 in command -
                BEGIN add_job('ST_MAN', 'Stock Manager'); END;
                Error report -
                ORA-00001: нарушено ограничение уникальности (RUMINAT.JOB_ID_PK)
                ORA-06512: на  "RUMINAT.ADD_JOB", line 4
                ORA-06512: на  line 1
                00001. 00000 -  "unique constraint (%s.%s) violated"
                *Cause:    An UPDATE or INSERT statement attempted to insert a duplicate key.
                           For Trusted Oracle configured in DBMS MAC mode, you may see
                           this message if a duplicate entry exists at a different level.
                *Action:   Either remove the unique restriction or do not insert the key.</code></pre>
            <p>Мы получили ошибку, так как в таблице <code>Jobs</code> уже есть запись с ключом <code>ST_MAN</code>.</p>
          </div>
          <div class="task" id="task-9-2">
            <p class="task-text" name="task-9-2"><b>Задание 2.</b> Создайте процедуру <code>upd_job</code> для изменения значения в таблице <code>Jobs</code>.</p>
            <ul>
              <li>Процедура должна принимать на вход параметр <code>id</code> и новое значение для столбца <code>Job_Title</code>. Процедура должна оповещать пользователей, в случае если никаких модификаций не было сделано. Для этого воспользуйтесь атрибутом <code>SQL%FOUND</code> и инструкцией <code>RAISE_APPLICATION_ERROR</code> или <code>DBMS_OUTPUT.PUT_LINE</code>.</li>
              <li>Запустите процедуру на исполнение и поменяйте с ее помощью <code>Job_Title</code> для записи <code>IT_DBA</code> на <code>Data Administrator</code>. Сделайте выборку из таблицы <code>Jobs</code>, чтобы убедиться в модификации данных.</li>
              <li>Протестируйте работу процедуры в случае получения на вход несуществующего <code>Job_ID</code> — к примеру, <code>IT_WEB</code>.</li>
            </ul>
            <pre class="line-numbers undefined"><code class="language-plsql">CREATE OR REPLACE PROCEDURE
  upd_job (id Jobs.Job_ID%TYPE, jobTitle Jobs.Job_Title%TYPE) IS
BEGIN
  UPDATE Jobs
  SET Job_Title = jobTitle
  WHERE Job_ID = id;
  
  IF NOT SQL%FOUND THEN
    DBMS_OUTPUT.PUT_LINE('upd_job error:');
    DBMS_OUTPUT.PUT_LINE(
         '  there were no modifications applied for'
      || ' upd_job(''' || id || ''', ''' || jobTitle || ''').'
    );
    DBMS_OUTPUT.PUT_LINE('  There is no job with ID ''' || id || '''.');
  END IF;
END upd_job;</code></pre>
            <pre><code class="language-output">
                Procedure UPD_JOB compiled
                </code></pre>
            <pre class="line-numbers undefined"><code class="language-plsql">
                EXECUTE upd_job ('IT_DBA', 'Data Administrator')
                SELECT * FROM Jobs WHERE Job_ID = 'IT_DBA';</code></pre><row class="aligment-center"><table class="table table-SQL table-bordered table-hover table-sm"><thead class="thead-dark"><tr><th>JOB_ID</th><th>JOB_TITLE</th><th>MIN_SALARY</th><th>MAX_SALARY</th></tr></thead><tbody><tr><td>IT_DBA</td><td>Data Administrator</td><td>(null)</td><td>(null)</td></tr></tbody></table></row>
            <pre class="line-numbers undefined"><code class="language-plsql">EXECUTE upd_job ('IT_WEB', 'Web developer')</code></pre>
            <pre><code class="language-output">
                upd_job error:
                  there were no modifications applied for upd_job('IT_WEB', 'Web developer').
                  There is no job with ID 'IT_WEB'.
                
                </code></pre>
          </div>
          <div class="task" id="task-9-3">
            <p class="task-text" name="task-9-3"><b>Задание 3.</b> Создайте процедуру <code>del_job</code> для удаления записей из таблицы <code>Jobs</code>.</p>
            <ul>
              <li>Создайте процедуру с одним входным параметром — <code>id</code>. Создайте в процедуре обработчик на случай, если ни одна запись не будет удалена.</li>
              <li>Протестируйте работу процедуры: вызовите её на исполнение и попытайтесь удалить существующую запись с <code>Job_ID = IT_DBA</code>.</li>
              <li>Протестируйте работу процедуры: вызовите её на исполнение и попытайтесь с ее помощью удалить несуществующую запись, к примеру с <code>Job_ID = IT_WEB</code>. Зафиксируйте сообщение об ошибке.</li>
            </ul>
            <pre class="line-numbers undefined"><code class="language-plsql">CREATE OR REPLACE PROCEDURE
  del_job (id Jobs.Job_ID%TYPE) IS
BEGIN
  DELETE FROM Jobs WHERE Job_ID = id;
  
  IF NOT SQL%FOUND THEN
    DBMS_OUTPUT.PUT_LINE('del_job error:');
    DBMS_OUTPUT.PUT_LINE(
         '  there were no records deleted by'
      || ' del_job(''' || id || ''').'
    );
    DBMS_OUTPUT.PUT_LINE('  There is no job with ID ''' || id || '''.');
  END IF;
END del_job;</code></pre>
            <pre><code class="language-output">
                Procedure DEL_JOB compiled
                </code></pre>
            <pre class="line-numbers undefined"><code class="language-plsql">
                EXECUTE del_job ('IT_DBA')
                SELECT * FROM Jobs WHERE Job_ID = 'IT_DBA';</code></pre><row class="aligment-center"><table class="table table-SQL table-bordered table-hover table-sm"><thead class="thead-dark"><tr><th>JOB_ID</th><th>JOB_TITLE</th><th>MIN_SALARY</th><th>MAX_SALARY</th></tr></thead><tbody></tbody></table></row>
            <pre class="line-numbers undefined"><code class="language-plsql">EXECUTE del_job ('IT_WEB')</code></pre>
            <pre><code class="language-output">
                del_job error:
                  there were no records deleted by del_job('IT_WEB').
                  There is no job with ID 'IT_WEB'.
                </code></pre>
          </div>
          <div class="task" id="task-9-4">
            <p class="task-text" name="task-9-4"><b>Задание 4.</b> Создайте процедуру <code>get_employee</code> для выборки из таблицы <code>Employees</code> значений <code>Job_ID</code> и <code>Salary</code> указанного сотрудника.</p>
            <ul>
              <li>Процедура должна принимать на вход <code>Employee_ID</code> и возвращать с помощью <code>OUT</code> параметров значения <code>Job_ID</code> и <code>Salary</code>.</li>
              <li>Протестируйте работу процедуры передавая на вход локальные переменные блока вызова или хост-переменные. Просмотрите зарплату и должность для <code>120</code> сотрудника.</li>
              <li>Просмотрите зарплату и должность для <code>300</code> сотрудника.</li>
            </ul>
            <pre class="line-numbers undefined"><code class="language-plsql">CREATE OR REPLACE PROCEDURE
  get_employee (
    id            Employees.Employee_ID%TYPE,
    jobID     OUT Employees.Job_ID%TYPE,
    empSalary OUT Employees.Salary%TYPE
  ) IS
BEGIN
  SELECT Job_ID, Salary
  INTO   jobID,  empSalary
  FROM Employees
  WHERE Employee_ID = id;

EXCEPTION
  WHEN NO_DATA_FOUND THEN
    DBMS_OUTPUT.PUT_LINE('get_employee error:');
    DBMS_OUTPUT.PUT_LINE(
         '  could not get Employee information from'
      || ' get_employee(' || id || ', jobID, empSalary).'
    );
    DBMS_OUTPUT.PUT_LINE('  There is no employee with ID ' || id || '.');
END get_employee;</code></pre>
            <pre><code class="language-output">Procedure GET_EMPLOYEE compiled</code></pre>
            <pre class="line-numbers undefined"><code class="language-plsql">DECLARE
  jobID     Employees.Job_ID%TYPE;
  empSalary Employees.Salary%TYPE;
BEGIN
  get_employee(120, jobID, empSalary);
  DBMS_OUTPUT.PUT_LINE(
       'Employee #120: Job_ID = ' || NVL(jobID, '(null)')
    || ', Salary = ' || NVL(TO_CHAR(empSalary), '(null)') || '.'
  );
  get_employee(300, jobID, empSalary);
  DBMS_OUTPUT.PUT_LINE(
       'Employee #300: Job_ID = ' || NVL(jobID, '(null)')
    || ', Salary = ' || NVL(TO_CHAR(empSalary), '(null)') || '.'
  );
END;</code></pre>
            <pre><code class="language-output">
                Employee #120: Job_ID = ST_MAN, Salary = 8000.
                get_employee error:
                  could not get Employee information from get_employee(300, jobID, empSalary).
                  There is no employee with ID 300.
                Employee #300: Job_ID = (null), Salary = (null).</code></pre>
          </div>
        </div>
        <div class="lab" id="lab-10"><a name="#lab-10">
            <h4>Практическое занятие 10. Создание функций</h4></a>
          <ul>
            <li>Создание функций.</li>
            <li>Уровень чистоты.</li>
          </ul>
          <div class="task" id="task-10-1">
            <p class="task-text" name="task-10-1"><b>Задание 1.</b> Создайте функцию <code>get_job</code>, которая возвращает <code>Job_Title</code>.</p>
            <ul>
              <li>Создайте функцию <code>get_job</code>, которая возвращает <code>Job_Title</code>, соответствующий переданному на вход <code>Job_ID</code>.</li>
              <li>Для тестирования работы функции создайте анонимный блок, объявите хост-переменную <code>b_title</code> типа <code>VARCHAR2</code>, сохраните в нее результат работы функции и выведите результат работы функции для значения входного параметра <code>SA_REP</code>.</li>
            </ul>
            <pre class="line-numbers undefined"><code class="language-plsql">CREATE OR REPLACE FUNCTION
  get_job (id Jobs.Job_ID%TYPE)
RETURN Jobs.Job_Title%TYPE IS
  title Jobs.Job_Title%TYPE;
BEGIN
  SELECT Job_Title
  INTO   title
  FROM Jobs
  WHERE Job_ID = id;

  RETURN title;
END get_job;</code></pre>
            <pre><code class="language-output">
                Function GET_JOB compiled
                </code></pre>
            <pre class="line-numbers undefined"><code class="language-plsql">VARIABLE b_title VARCHAR2;
DECLARE
  id Jobs.Job_ID%TYPE := 'SA_REP';
BEGIN
  :b_title := get_job(id);
  DBMS_OUTPUT.PUT_LINE('get_job(''' || id || ''') = ' || :b_title);
END;</code></pre>
            <pre><code class="language-output">
                get_job('SA_REP') = Sales Representative
                
                </code></pre>
          </div>
          <div class="task" id="task-10-2">
            <p class="task-text" name="task-10-2"><b>Задание 2.</b> Создайте функцию <code>get_annual_comp</code> для формирования фактической зарплаты сотрудника по заданной формуле.</p>
            <ul>
              <li>Формула: <code>(salary * 12) + (commission_pct * salary * 12)</code>. Функция должна принимать на вход месячную зарплату сотрудника и комиссию, и даже в случае если оба значения будут <code>NULL</code> возвращать не <code>NULL</code>.</li>
              <li>Протестируйте работу функции с помощью оператора <code>SELECT</code> для сотрудников из <code>30</code> отдела.</li>
            </ul>
            <pre class="line-numbers undefined"><code class="language-plsql">CREATE OR REPLACE FUNCTION
  get_annual_comp (
    sal Employees.Salary%TYPE,
    pct Employees.Commission_PCT%TYPE
  )
RETURN NUMBER IS 
BEGIN
  RETURN (NVL(sal, 0) * 12) + (NVL(pct, 0) * NVL(sal, 0) * 12);
END get_annual_comp;</code></pre>
            <pre><code class="language-output">
                Function GET_ANNUAL_COMP compiled
                </code></pre>
            <pre class="line-numbers undefined"><code class="language-plsql">SELECT
  Last_Name                               AS "Employee"      ,
  Salary                                  AS "Salary"        ,
  NVL(TO_CHAR(Commission_PCT), ' ')       AS "Commission_PCT",
  get_annual_comp(Salary, Commission_PCT) AS "Result" 
FROM Employees
WHERE Department_ID = 30;</code></pre><row class="aligment-center"><table class="table table-SQL table-bordered table-hover table-sm"><thead class="thead-dark"><tr><th>Employee</th><th>Salary</th><th>Commission_PCT</th><th>Result</th></tr></thead><tbody><tr><td>Raphaely</td><td>11000</td><td></td><td>132000</td></tr><tr><td>Khoo</td><td>3100</td><td></td><td>37200</td></tr><tr><td>Baida</td><td>2900</td><td></td><td>34800</td></tr><tr><td>Tubias</td><td>2800</td><td></td><td>33600</td></tr><tr><td>Himuro</td><td>2600</td><td></td><td>31200</td></tr><tr><td>Colmenares</td><td>2500</td><td></td><td>30000</td></tr></tbody></table></row>
          </div>
          <div class="task" id="task-10-3">
            <p class="task-text" name="task-10-3"><b>Задание 3.</b> Создайте процедуру <code>add_employee</code> для добавления нового сотрудника в табличку <code>Employees</code>. Перед добавлением сотрудника процедура должна проверять с помощью функции <code>valid_deptid</code>, что указанный для него номер отдела присутствует в таблице <code>Departments</code>.</p>
            <ul>
              <li>Создайте функцию <code>valid_deptid</code>, которая принимает на вход номер отдела и возвращает <code>TRUE</code> или <code>FALSE</code>, в зависимости от того есть или нет такой отдел в таблице <code>Departments</code>.</li>
              <li>Создайте процедуру <code>add_employee</code>, которая добавляет запись в таблицу <code>Employees</code> только в том случае, если функция <code>valid_deptid</code> вернула <code>TRUE</code>, иначе выдает соответствующее сообщение об ошибке. Процедура принимает на вход следующие параметры и присваивает им указанные в скобках значения по умолчанию:
                <ol>
                  <li><code>first_name</code>,</li>
                  <li><code>last_name</code>,</li>
                  <li><code>e-mail</code>,</li>
                  <li><code>job (SA_REP)</code>,</li>
                  <li><code>mgr (145)</code>,</li>
                  <li><code>sal (1000)</code>,</li>
                  <li><code>comm (0)</code>,</li>
                  <li><code>deptid (30)</code>.</li>
                </ol>Для генерации уникального идентификатора сотрудника воспользуйтесь последовательностью <code>Employees_Seq</code>.
                Установите значение в столбце <code>Hire_Date</code> с помощью функции <code>TRUNC(SYSDATE)</code>.
              </li>
              <li>Протестируйте работу процедуры для сотрудника <code>Jane Harris</code> из <code>15</code> отдела с e-mail-ом <code>JAHARRIS</code> (остальные значения оставьте по умолчанию). Зафиксируйте и объясните результат.</li>
              <li>Протестируйте работу процедуры для сотрудника <code>Joe Harris</code> из <code>80</code> отдела с e-mail-ом <code>JHARRIS</code> (остальные значения оставьте по умолчанию). Зафиксируйте и объясните результат.</li>
            </ul>
            <pre class="line-numbers undefined"><code class="language-plsql">CREATE OR REPLACE FUNCTION
  valid_deptid (depID Departments.Department_ID%TYPE)
RETURN BOOLEAN IS 
BEGIN
  FOR i IN (
      SELECT 'Exists' FROM dual
      WHERE EXISTS (
        SELECT Department_ID
        FROM Departments
        WHERE Department_ID = depID
      )
    )
  LOOP
    RETURN TRUE;
  END LOOP;
  RETURN FALSE;
END valid_deptid;
/


CREATE OR REPLACE PROCEDURE
  add_employee (
    firstName Employees.First_Name%TYPE
  ,  lastName Employees.Last_Name%TYPE
  ,      mail Employees.Email%TYPE
  ,       job Employees.Job_ID%TYPE          := 'SA_REP'
  ,       mgr Employees.Manager_ID%TYPE      := 145
  ,       sal Employees.Salary%TYPE          := 1000
  ,      comm Employees.Commission_PCT%TYPE  := 0
  ,     depID Employees.Department_ID%TYPE   := 30
  ) IS
BEGIN
  IF valid_deptid(depID) THEN
    INSERT INTO Employees (
      Employee_ID
    , First_Name
    , Last_Name
    , Email
    , Hire_Date
    , Job_ID
    , Manager_ID
    , Salary
    , Commission_PCT
    , Department_ID
    )
    VALUES (
      Employees_Seq.NEXTVAL -- Employee_ID
    , firstName
    , lastName
    , mail
    , TRUNC(SYSDATE) -- Hire_Date
    , job
    , mgr
    , sal
    , comm
    , depID
    );
  ELSE
    DBMS_OUTPUT.PUT_LINE(
      'Error: cannot add an employee to a nonexistent department #' || depID || '.'
    );
  END IF;
END add_employee;
/</code></pre>
            <pre><code class="language-output">
                Function VALID_DEPTID compiled
                Procedure ADD_EMPLOYEE compiled
                </code></pre>
            <pre class="line-numbers undefined"><code class="language-plsql">EXECUTE add_employee('Jane', 'Harris', 'JAHARRIS', depID => 15)</code></pre>
            <pre><code class="language-output">
                Error: cannot add an employee to a nonexistent department #15.
                </code></pre>
            <p>Ничего не получилось, потому что не существует 15-го отдела.</p>
            <pre class="line-numbers undefined"><code class="language-plsql">
                EXECUTE add_employee('Joe', 'Harris', 'JHARRIS', depID => 80)
                SELECT * FROM Employees WHERE Last_Name = 'Harris'</code></pre><row class="aligment-center"><table class="table table-SQL table-bordered table-hover table-sm"><thead class="thead-dark"><tr><th>EMPLOYEE_ID</th><th>FIRST_NAME</th><th>LAST_NAME</th><th>EMAIL</th><th>PHONE_NUMBER</th><th>HIRE_DATE</th><th>JOB_ID</th><th>SALARY</th><th>COMMISSION_PCT</th><th>MANAGER_ID</th><th>DEPARTMENT_ID</th></tr></thead><tbody><tr><td>207</td><td>Joe</td><td>Harris</td><td>JHARRIS</td><td>(null)</td><td>26.03.19</td><td>SA_REP</td><td>1000</td><td>0</td><td>145</td><td>80</td></tr></tbody></table></row>
            <p>Теперь мы добавляем в существующий отдел, поэтому всё хорошо.</p>
          </div>
        </div>
        <div class="lab" id="lab-12"><a name="#lab-12">
            <h4>Практическое занятие 12. Создание пакетов</h4></a>
          <ul>
            <li>Создание пакетов. </li>
            <li>Элементы пакета.</li>
            <li><code>private</code> и <code>public</code> конструкции пакета.</li>
          </ul>
          <div class="task" id="task-12-1">
            <p class="task-text" name="task-12-1"><b>Задание 1.</b> Создайте спецификацию и тело пакета <code>job_pkg</code>, и сохраните в нем созданные ранее процедуры и функции <code>add_job</code>, <code>upd_job</code>, <code>del_job</code>, <code>get_job</code>. Сохраните код создания спецификации и тела пакета в разных файлах <code>*.sql</code>. Для упрощения отладки включите инструкцию <code>show errors</code> в каждый скрипт.</p>
            <ul>
              <li>Создайте спецификацию пакета. Объявите публичные элементы.</li>
              <li>Создайте тело пакета. Включите в него реализацию процедур и функций.</li>
              <li>Удалите ранее созданные (независимые) процедуры и функции: <code>add_job</code>, <code>upd_job</code>, <code>del_job</code>, <code>get_job</code>.</li>
              <li>Протестируйте работу пакета. Запустите на исполнение процедуру <code>job_pkg.add_job</code> передав в качестве значений параметров:</li>
              <ul>
                <li><code>IT_SYSAN</code>, <code>Systems analyst</code>.</li>
              </ul>
              <li>Сделайте выборку из таблицы <code>Jobs</code>, чтобы просмотреть результат работы процедуры.</li>
            </ul>
            <pre class="line-numbers undefined"><code class="language-plsql">CREATE OR REPLACE PACKAGE job_pkg IS
  PROCEDURE add_job (id Jobs.Job_ID%TYPE, job_title Jobs.Job_Title%TYPE);
  PROCEDURE upd_job (id Jobs.Job_ID%TYPE, jobTitle Jobs.Job_Title%TYPE);
  PROCEDURE del_job (id Jobs.Job_ID%TYPE);
  FUNCTION  get_job (id Jobs.Job_ID%TYPE) RETURN Jobs.Job_Title%TYPE;
END job_pkg;</code></pre>
            <pre><code class="language-output">Package JOB_PKG compiled</code></pre>
            <pre class="line-numbers undefined"><code class="language-plsql">CREATE OR REPLACE PACKAGE BODY job_pkg IS

  PROCEDURE add_job (id Jobs.Job_ID%TYPE, job_title Jobs.Job_Title%TYPE) IS
  BEGIN
    INSERT INTO Jobs (Job_ID, Job_Title)
    VALUES           (id,     job_title);
  END add_job;


  PROCEDURE upd_job (id Jobs.Job_ID%TYPE, jobTitle Jobs.Job_Title%TYPE) IS
  BEGIN
    UPDATE Jobs
    SET Job_Title = jobTitle
    WHERE Job_ID = id;
    
    IF NOT SQL%FOUND THEN
      DBMS_OUTPUT.PUT_LINE('upd_job error:');
      DBMS_OUTPUT.PUT_LINE(
           '  there were no modifications applied for'
        || ' upd_job(''' || id || ''', ''' || jobTitle || ''').'
      );
      DBMS_OUTPUT.PUT_LINE('  There is no job with ID ''' || id || '''.');
    END IF;
  END upd_job;


  PROCEDURE del_job (id Jobs.Job_ID%TYPE) IS
  BEGIN
    DELETE FROM Jobs WHERE Job_ID = id;
    
    IF NOT SQL%FOUND THEN
      DBMS_OUTPUT.PUT_LINE('del_job error:');
      DBMS_OUTPUT.PUT_LINE(
           '  there were no records deleted by'
        || ' del_job(''' || id || ''').'
      );
      DBMS_OUTPUT.PUT_LINE('  There is no job with ID ''' || id || '''.');
    END IF;
  END del_job;


  FUNCTION get_job (id Jobs.Job_ID%TYPE)
  RETURN Jobs.Job_Title%TYPE IS
    title Jobs.Job_Title%TYPE;
  BEGIN
    SELECT Job_Title
    INTO   title
    FROM Jobs
    WHERE Job_ID = id;

    RETURN title;
  END get_job;

END job_pkg;</code></pre>
            <pre><code class="language-output">
                Package Body JOB_PKG compiled
                </code></pre>
            <pre class="line-numbers undefined"><code class="language-plsql">
                DROP PROCEDURE add_job;
                DROP PROCEDURE upd_job;
                DROP PROCEDURE del_job;
                DROP FUNCTION  get_job;</code></pre>
            <pre><code class="language-output">
                Procedure ADD_JOB dropped.
                Procedure UPD_JOB dropped.
                Procedure DEL_JOB dropped.
                Function GET_JOB dropped.
                </code></pre>
            <pre class="line-numbers undefined"><code class="language-plsql">
                EXECUTE job_pkg.add_job('IT_SYSAN', 'Systems analyst')
                SELECT * FROM Jobs WHERE Job_ID = 'IT_SYSAN'</code></pre><row class="aligment-center"><table class="table table-SQL table-bordered table-hover table-sm"><thead class="thead-dark"><tr><th>JOB_ID</th><th>JOB_TITLE</th><th>MIN_SALARY</th><th>MAX_SALARY</th></tr></thead><tbody><tr><td>IT_SYSAN</td><td>Systems analyst</td><td>(null)</td><td>(null)</td></tr></tbody></table></row>
          </div>
          <div class="task" id="task-12-2">
            <p class="task-text" name="task-12-2"><b>Задание 2.</b> Создайте пакет, состоящий из <code>public</code> и <code>private</code> конструкций.</p>
            <ul>
              <li>Создайте спецификацию и тело пакета <code>emp_pkg</code>, в котором есть <code>public</code> процедуры <code>add_employee</code> и <code>get_employee</code>, и <code>private</code> функция <code>valid_deptid</code>.</li>
              <li>Протестируйте работу процедуры <code>emp_pkg.add_employee</code>. Добавьте в таблицу информацию о сотруднике <code>Jane Harris</code> из <code>15</code> отдела, с e-mail-ом <code>JAHARRIS</code>. Вы должны получить сообщение об ошибке, потому что 15 отдела не существует.</li>
              <li>Запустите процедуру еще раз и добавьте информацию о <code>David Smith</code> из <code>80</code> отдела, с e-mail-ом <code>DASMITH</code>.</li>
              <li>Сделайте выборку из таблицы <code>Employees</code>, чтобы убедиться в корректном добавлении новых сотрудников.</li>
            </ul>
            <pre class="line-numbers undefined"><code class="language-plsql">CREATE OR REPLACE PACKAGE emp_pkg IS
  PROCEDURE add_employee (
    firstName Employees.First_Name%TYPE
  ,  lastName Employees.Last_Name%TYPE
  ,      mail Employees.Email%TYPE
  ,       job Employees.Job_ID%TYPE          := 'SA_REP'
  ,       mgr Employees.Manager_ID%TYPE      := 145
  ,       sal Employees.Salary%TYPE          := 1000
  ,      comm Employees.Commission_PCT%TYPE  := 0
  ,     depID Employees.Department_ID%TYPE   := 30
  );

  PROCEDURE get_employee (
    id            Employees.Employee_ID%TYPE
  , jobID     OUT Employees.Job_ID%TYPE
  , empSalary OUT Employees.Salary%TYPE
  );
END emp_pkg;</code></pre>
            <pre><code class="language-output">Package EMP_PKG compiled</code></pre>
            <pre class="line-numbers undefined"><code class="language-plsql">CREATE OR REPLACE PACKAGE BODY emp_pkg IS

  /*
    --- PRIVATE ---
  */
  FUNCTION valid_deptid (depID Departments.Department_ID%TYPE)
  RETURN BOOLEAN IS 
  BEGIN
    FOR i IN (
        SELECT 'Exists' FROM dual
        WHERE EXISTS (
          SELECT Department_ID
          FROM Departments
          WHERE Department_ID = depID
        )
      )
    LOOP
      RETURN TRUE;
    END LOOP;
    RETURN FALSE;
  END valid_deptid;


  /*
    --- PUBLIC ---
  */
  PROCEDURE add_employee (
      firstName Employees.First_Name%TYPE
    ,  lastName Employees.Last_Name%TYPE
    ,      mail Employees.Email%TYPE
    ,       job Employees.Job_ID%TYPE          := 'SA_REP'
    ,       mgr Employees.Manager_ID%TYPE      := 145
    ,       sal Employees.Salary%TYPE          := 1000
    ,      comm Employees.Commission_PCT%TYPE  := 0
    ,     depID Employees.Department_ID%TYPE   := 30
    ) IS
  BEGIN
    IF valid_deptid(depID) THEN
      INSERT INTO Employees (
        Employee_ID
      , First_Name
      , Last_Name
      , Email
      , Hire_Date
      , Job_ID
      , Manager_ID
      , Salary
      , Commission_PCT
      , Department_ID
      )
      VALUES (
        Employees_Seq.NEXTVAL -- Employee_ID
      , firstName
      , lastName
      , mail
      , TRUNC(SYSDATE) -- Hire_Date
      , job
      , mgr
      , sal
      , comm
      , depID
      );
    ELSE
      DBMS_OUTPUT.PUT_LINE(
        'Error: cannot add an employee to a nonexistent department #' || depID || '.'
      );
    END IF;
  END add_employee;


  PROCEDURE get_employee (
      id            Employees.Employee_ID%TYPE,
      jobID     OUT Employees.Job_ID%TYPE,
      empSalary OUT Employees.Salary%TYPE
    ) IS
  BEGIN
    SELECT Job_ID, Salary
    INTO   jobID,  empSalary
    FROM Employees
    WHERE Employee_ID = id;

  EXCEPTION
    WHEN NO_DATA_FOUND THEN
      DBMS_OUTPUT.PUT_LINE('get_employee error:');
      DBMS_OUTPUT.PUT_LINE(
           '  could not get Employee information from'
        || ' get_employee(' || id || ', jobID, empSalary).'
      );
      DBMS_OUTPUT.PUT_LINE('  There is no employee with ID ' || id || '.');
  END get_employee;

END emp_pkg;</code></pre>
            <pre><code class="language-output">
                Package Body EMP_PKG compiled
                </code></pre>
            <pre class="line-numbers undefined"><code class="language-plsql">EXECUTE emp_pkg.add_employee('Jane', 'Harris', 'JAHARRIS', depID => 15)</code></pre>
            <pre><code class="language-output">
                Error: cannot add an employee to a nonexistent department #15.
                </code></pre>
            <pre class="line-numbers undefined"><code class="language-plsql">
                EXECUTE emp_pkg.add_employee('David', 'Smith', 'DASMITH', depID => 80)
                SELECT * FROM Employees WHERE Last_Name = 'Smith'
                </code></pre><row class="aligment-center"><table class="table table-SQL table-bordered table-hover table-sm"><thead class="thead-dark"><tr><th>EMPLOYEE_ID</th><th>FIRST_NAME</th><th>LAST_NAME</th><th>EMAIL</th><th>PHONE_NUMBER</th><th>HIRE_DATE</th><th>JOB_ID</th><th>SALARY</th><th>COMMISSION_PCT</th><th>MANAGER_ID</th><th>DEPARTMENT_ID</th></tr></thead><tbody>
<tr><td>210</td><td>David</td><td>Smith</td><td>DASMITH</td><td>(null)</td><td>27.03.19</td><td>SA_REP</td><td>1000</td><td>0</td><td>145</td><td>80</td></tr>
<tr><td>159</td><td>Lindsey</td><td>Smith</td><td>LSMITH</td><td>011.44.1345.729268</td><td>10.03.05</td><td>SA_REP</td><td>8000</td><td>0.3</td><td>146</td><td>80</td></tr>
<tr><td>171</td><td>William</td><td>Smith</td><td>WSMITH</td><td>011.44.1343.629268</td><td>23.02.07</td><td>SA_REP</td><td>7400</td><td>0.15</td><td>148</td><td>80</td></tr>
</tbody></table></row>
          </div>
        </div>
        <div class="lab" id="lab-13"><a name="#lab-13">
            <h4>Практическое занятие 13. Работа с пакетами</h4></a>
          <ul>
            <li>Обслуживание пакетов.</li>
            <li>Устойчивое состояние пакета. </li>
            <li><code>PRAGMA SERIALLY_REUSABLE</code>.</li>
          </ul>
          <div class="task" id="task-13-1">
            <p class="task-text" name="task-13-1"><b>Задание 1.</b> Измените пакет <code>emp_pkg</code>, созданный в практическом занятии 12. Необходимо перегрузить процедуру <code>add_employee</code>. Для этого:</p>
            <ul>
              <li>В спецификацию пакета добавьте описание еще одной процедуры <code>add_employee</code>, принимающей на вход 3 параметра:
                <ul>
                  <li><code>first_name</code>, <code>last_name</code> и <code>department_id</code>. </li>
                </ul>
              </li>
              <li>Сохраните и скомпилируйте внесенные изменения.</li>
              <li>Создайте реализацию новой процедуры в теле пакета. 
                <ul>
                  <li>Процедура должна формировать e-mail адрес из первой буквы имени и семи первых букв фамилий сотрудника — в верхнем регистре. </li>
                  <li>После формирования e-mail, новая версия процедуры <code>add_employee</code> должна вызывать на исполнение старую версию этой процедуры из этого же пакета, для добавления записи в таблицу. Сформированный e-mail передается при вызове в качестве входного параметра.</li>
                  <li>Сохраните и скомпилируйте тело пакета.</li>
                </ul>
              </li>
              <li>Запустите процедуру на исполнение передав значения параметров:
                <ul>
                  <li><code>Samuel Joplin</code> и <code>30</code> отдел.</li>
                </ul>
              </li>
            </ul>
            <pre class="line-numbers undefined"><code class="language-plsql">
                CREATE OR REPLACE PACKAGE emp_pkg IS
                  
                  -- .....................
                
                  PROCEDURE add_employee (
                    firstName Employees.First_Name%TYPE
                  ,  lastName Employees.Last_Name%TYPE
                  ,     depID Employees.Department_ID%TYPE
                  );
                
                  -- .....................
                
                END emp_pkg;</code></pre>
            <pre><code class="language-output">Package EMP_PKG compiled</code></pre>
            <pre class="line-numbers undefined"><code class="language-plsql">
                CREATE OR REPLACE PACKAGE BODY emp_pkg IS
                
                  -- .....................
                
                  PROCEDURE add_employee (
                      firstName Employees.First_Name%TYPE
                    ,  lastName Employees.Last_Name%TYPE
                    ,     depID Employees.Department_ID%TYPE
                    ) IS
                    email Employees.Email%TYPE := UPPER(SUBSTR(firstName, 1, 1)) || UPPER(SUBSTR(lastName, 1, 7));
                  BEGIN
                    add_employee(firstName, lastName, mail => email, depID => depID);
                  END add_employee;
                
                  -- .....................
                
                END emp_pkg;</code></pre>
            <pre><code class="language-output">
                Package Body EMP_PKG compiled
                </code></pre>
            <pre class="line-numbers undefined"><code class="language-plsql">
                EXECUTE emp_pkg.add_employee('Samuel', 'Joplin', 30)
                SELECT * FROM Employees WHERE Last_Name = 'Joplin'</code></pre><row class="aligment-center"><table class="table table-SQL table-bordered table-hover table-sm"><thead class="thead-dark"><tr><th>EMPLOYEE_ID</th><th>FIRST_NAME</th><th>LAST_NAME</th><th>EMAIL</th><th>PHONE_NUMBER</th><th>HIRE_DATE</th><th>JOB_ID</th><th>SALARY</th><th>COMMISSION_PCT</th><th>MANAGER_ID</th><th>DEPARTMENT_ID</th></tr></thead><tbody><tr><td>211</td><td>Samuel</td><td>Joplin</td><td>SJOPLIN</td><td>(null)</td><td>02.04.19</td><td>SA_REP</td><td>1000</td><td>0</td><td>145</td><td>30</td></tr></tbody></table></row>
          </div>
          <div class="task" id="task-13-2">
            <p class="task-text" name="task-13-2"><b>Задание 2.</b> В пакете <code>emp_pkg</code> создайте 2 функции <code>get_employee</code>.</p>
            <ul>
              <li>В спецификацию пакета добавьте объявление функций:
                <ul>
                  <li><code>get_employee</code>, которая принимает на вход параметр <code>p_emp_id</code> типа <code>Employees.Employee_ID%TYPE</code> Функция должна возвращать значение типа <code>Employees%ROWTYPE</code> (запись, соответствующую структуре таблицы <code>Employees</code>).</li>
                  <li><code>get_employee</code>, которая принимает на вход параметр <code>p_family_name</code> типа <code>Employees.Last_Name%TYPE</code>. Функция должна возвращать значение типа <code>Employees%ROWTYPE</code> (запись, соответствующую структуре таблицы <code>Employees</code>).</li>
                </ul>
              </li>
              <li>Скомпилируйте спецификацию пакета.</li>
              <li>В тело пакета добавьте реализацию функций.
                <ul>
                  <li>Первая <code>get_employee</code> должна содержать выборку, возвращающую запись о сотруднике с переданным на вход значением <code>Employee_ID</code>, </li>
                  <li>Вторая <code>get_employee</code> должна отбирать записи о сотрудниках с переданной на вход фамилией <code>p_family_name</code>.</li>
                </ul>
              </li>
              <li>Скомпилируйте тело пакета.</li>
              <li>Добавьте в пакет процедуру <code>print_employee</code>.
                <ul>
                  <li>Процедура принимает на вход параметр типа <code>Employees%ROWTYPE</code>. </li>
                  <li>С помощью <code>DBMS_OUTPUT.PUT_LINE</code> выводит значение из полей <code>Department_ID</code>, <code>Employee_ID</code>, <code>First_Name</code>, <code>Last_Name</code>, <code>Job_ID</code>, <code>Salary</code>.</li>
                </ul>
              </li>
              <li>Скомпилируйте пакет.</li>
              <li>С помощью анонимного блока протестируйте работу пакета. Для этого запустите на исполнение процедуру <code>emp_pkg.get_employee</code>, передав ей на вход <code>employee_id = 100</code>, <code>family_name = 'Joplin'</code>. А потом с помощью процедуры <code>emp_pkg.print_employee</code> распечатайте результат.</li>
            </ul>
            <pre class="line-numbers undefined"><code class="language-plsql">
                CREATE OR REPLACE PACKAGE emp_pkg IS
                  
                  -- .....................
                
                  FUNCTION get_employee (p_emp_id Employees.Employee_ID%TYPE)
                  RETURN Employees%ROWTYPE;
                
                  FUNCTION get_employee (p_family_name Employees.Last_Name%TYPE)
                  RETURN Employees%ROWTYPE;
                
                  PROCEDURE print_employee (emp Employees%ROWTYPE);
                END emp_pkg;</code></pre>
            <pre><code class="language-output">Package EMP_PKG compiled</code></pre>
            <pre class="line-numbers undefined"><code class="language-plsql">
                CREATE OR REPLACE PACKAGE BODY emp_pkg IS
                
                  -- .....................
                
                  FUNCTION get_employee (p_emp_id Employees.Employee_ID%TYPE)
                  RETURN Employees%ROWTYPE IS
                    emp Employees%ROWTYPE;
                  BEGIN
                    SELECT *
                    INTO   emp
                    FROM Employees
                    WHERE Employee_ID = p_emp_id;
                
                    RETURN emp;
                  END;
                
                  FUNCTION get_employee (p_family_name Employees.Last_Name%TYPE)
                  RETURN Employees%ROWTYPE IS
                    emp Employees%ROWTYPE;
                  BEGIN
                    SELECT *
                    INTO   emp
                    FROM Employees
                    WHERE Last_Name = p_family_name;
                
                    RETURN emp;
                  END;
                
                  PROCEDURE print_employee (emp Employees%ROWTYPE) IS BEGIN
                    DBMS_OUTPUT.PUT_LINE(
                         'Emp#' || emp.Employee_ID || ': '
                      || emp.First_Name || ' ' || emp.Last_Name
                      || ', depID is '  || emp.Department_ID
                      || ', job is '    || emp.Job_ID
                      || ', salary is ' || emp.Salary || '.'
                    );
                  END;
                
                END emp_pkg;</code></pre>
            <pre><code class="language-output">
                Package Body EMP_PKG compiled
                </code></pre>
            <pre class="line-numbers undefined"><code class="language-plsql">
                BEGIN
                  emp_pkg.print_employee(emp_pkg.get_employee(100));
                  emp_pkg.print_employee(emp_pkg.get_employee('Joplin'));
                END;</code></pre>
            <pre><code class="language-output">
                Emp#100: Steven King, depID is 90, job is AD_PRES, salary is 24000.
                Emp#211: Samuel Joplin, depID is 30, job is SA_REP, salary is 1000.
                
                </code></pre>
          </div>
          <div class="task" id="task-13-3">
            <p class="task-text" name="task-13-3"><b>Задание 3.</b> Структура отделов организации меняется не часто, поэтому для улучшения производительности пакета <code>emp_pkg</code> добавьте в него public процедуру <code>init_departments</code> и <code>private</code> индексную таблицу <code>valid_departments</code>. Процедура будет один раз, в начале работы с пакетом, заполнять индексную таблицу номерами существующих отделов, для повышения производительности использования функции <code>valid_deptid</code>, которая теперь будет анализировать не актуальную таблицу <code>Departments</code>, а индексную таблицу в теле пакета. Для этого:</p>
            <ul>
              <li>Добавьте в спецификацию пакета объявление процедуры <code>init_departments</code>, не принимающей на вход никаких параметров.</li>
              <li>Добавьте в тело пакета декларирование типа индексной таблицы, саму таблицу <code>valid_departments</code> и описание процедуры <code>init_departments</code>.
                <ul>
                  <li>Таблица хранит значения типа <code>BOOLEAN</code> и использует значения из столбца <code>Departments.Department_ID</code> в качестве индекса:</li>
                  <pre class="line-numbers undefined"><code class="language-plsql">
                      TYPE boolean_tab_type IS TABLE OF BOOLEAN INDEX BY BINARY_INTEGER;
                      valid_departments boolean_tab_type;</code></pre>
                  <li>Добавьте описание процедуры <code>init_departments</code> в конец тела пакета. Процедура должна заполнить индексную таблицу значениями: используйте значение столбца <code>Department_ID</code> в качестве индекса записи в <code>valid_departments</code>, а в качестве соответствующего значения записи используйте <code>TRUE</code>.</li>
                </ul>
              </li>
              <li>В теле пакета создайте инициализационный блок, в котором вызывается на исполнение процедура <code>init_departments</code>.</li>
              <li>Сохраните изменения и скомпилируйте пакет заново.</li>
            </ul>
            <pre class="line-numbers undefined"><code class="language-plsql">
                CREATE OR REPLACE PACKAGE emp_pkg IS
                  PROCEDURE init_departments;
                
                  -- .....................
                
                END emp_pkg;</code></pre>
            <pre><code class="language-output">
                Package EMP_PKG compiled
                </code></pre>
            <pre class="line-numbers undefined"><code class="language-plsql">
                CREATE OR REPLACE PACKAGE BODY emp_pkg IS
                
                  TYPE boolean_tab_type IS TABLE OF BOOLEAN INDEX BY BINARY_INTEGER;
                  valid_departments boolean_tab_type;
                
                  -- .....................
                
                  PROCEDURE init_departments IS BEGIN
                    FOR row IN (SELECT Department_ID FROM Departments) LOOP
                      valid_departments(row.Department_ID) := TRUE;
                    END LOOP;
                  END;
                
                BEGIN
                  init_departments();
                END emp_pkg;
                /</code></pre>
            <pre><code class="language-output">
                Package Body EMP_PKG compiled
                
                </code></pre>
          </div>
          <div class="task" id="task-13-4">
            <p class="task-text" name="task-13-4"><b>Задание 4.</b> Измените реализацию функции <code>valid_deptid</code>, таким образом, чтобы она анализировала содержимое индексированной таблицы.</p>
            <ul>
              <li>Поменяйте реализацию функции. Сохраните и скомпилируйте изменения.</li>
              <li>Протестируйте работу пакета. Вызовите на исполнение процедуру <code>add_employee</code> с параметрами
                <ul>
                  <li><code>name = 'James Bond'</code> и <code>department_id = 15</code>.</li>
                </ul>Что произойдет?
              </li>
              <li>Добавьте в таблицу <code>Departments</code> новый отдел с номером <code>15</code> и названием <code>Security</code>. Подтвердите модификацию с помощью инструкции <code>COMMIT</code>.</li>
              <li>Ещё раз вызовите на исполнение процедуру <code>add_employee</code> с параметрами:
                <ul>
                  <li><code>name = 'James Bond'</code> и <code>department_id = 15</code>.</li>
                </ul>Что произойдет теперь? Почему?
              </li>
              <li>Запустите на исполнение процедуру <code>emp_pkg.init_departments</code>. Зачем это надо сделать? На что это повлияет?</li>
              <li>Ещё раз вызовите на исполнение процедуру <code>add_employee</code> с параметрами
                <ul>
                  <li><code>name = 'James Bond'</code> и <code>department_id = 15</code>.</li>
                </ul>Что произойдет теперь? Почему?
              </li>
              <li>Удалите запись о <code>James Bond</code> и <code>15</code> отделе из соответствующих таблиц и ещё раз обновите таблицу <code>valid_departments</code>.</li>
            </ul>
            <pre class="line-numbers undefined"><code class="language-plsql">
                CREATE OR REPLACE PACKAGE emp_pkg IS
                  PROCEDURE init_departments;
                
                  -- .....................
                
                END emp_pkg;</code></pre>
            <pre><code class="language-output">
                Package EMP_PKG compiled
                </code></pre>
            <pre class="line-numbers undefined"><code class="language-plsql">
                CREATE OR REPLACE PACKAGE BODY emp_pkg IS
                
                  TYPE boolean_tab_type IS TABLE OF BOOLEAN INDEX BY BINARY_INTEGER;
                  valid_departments boolean_tab_type;
                
                  FUNCTION valid_deptid (depID Departments.Department_ID%TYPE)
                  RETURN BOOLEAN IS
                  BEGIN
                    IF valid_departments(depID) THEN RETURN TRUE;
                    ELSE RETURN FALSE; END IF;
                  EXCEPTION
                    WHEN OTHERS THEN RETURN FALSE;
                  END valid_deptid;
                
                  -- .....................
                
                  PROCEDURE init_departments IS BEGIN
                    FOR row IN (SELECT Department_ID FROM Departments) LOOP
                      valid_departments(row.Department_ID) := TRUE;
                    END LOOP;
                  END;
                
                BEGIN
                  init_departments();
                END emp_pkg;
                /</code></pre>
            <pre><code class="language-output">
                Package Body EMP_PKG compiled
                </code></pre>
            <pre class="line-numbers undefined"><code class="language-plsql">EXECUTE emp_pkg.add_employee('James', 'Bond', 15)</code></pre>
            <pre><code class="language-output">Error: cannot add an employee to a nonexistent department #15.</code></pre>
            <p>Ошибка — у нас нет 15-го отдела.</p>
            <pre class="line-numbers undefined"><code class="language-plsql">
                INSERT INTO Departments (Department_ID, Department_Name)
                VALUES                  (15,            'Security');
                COMMIT;</code></pre>
            <pre><code class="language-output">
                1 row inserted.
                Commit complete.
                </code></pre>
            <pre class="line-numbers undefined"><code class="language-plsql">EXECUTE emp_pkg.add_employee('James', 'Bond', 15)</code></pre>
            <pre><code class="language-output">Error: cannot add an employee to a nonexistent department #15.</code></pre>
            <p>Всё равно ошибка — мы не обновили таблицу <code>valid_departments</code>.</p>
            <pre class="line-numbers undefined"><code class="language-plsql">EXECUTE emp_pkg.init_departments()</code></pre>
            <p>Мы обновили таблицу, 15-ый отдел теперь виден функции <code>valid_deptid</code>.</p>
            <pre class="line-numbers undefined"><code class="language-plsql">
                EXECUTE emp_pkg.add_employee('James', 'Bond', 15)
                SELECT * FROM Employees WHERE Last_Name = 'Bond'</code></pre><row class="aligment-center"><table class="table table-SQL table-bordered table-hover table-sm"><thead class="thead-dark"><tr><th>EMPLOYEE_ID</th><th>FIRST_NAME</th><th>LAST_NAME</th><th>EMAIL</th><th>PHONE_NUMBER</th><th>HIRE_DATE</th><th>JOB_ID</th><th>SALARY</th><th>COMMISSION_PCT</th><th>MANAGER_ID</th><th>DEPARTMENT_ID</th></tr></thead><tbody><tr><td>214</td><td>James</td><td>Bond</td><td>JBOND</td><td>(null)</td><td>02.04.19</td><td>SA_REP</td><td>1000</td><td>0</td><td>145</td><td>15</td></tr></tbody></table></row>
            <pre class="line-numbers undefined"><code class="language-plsql">
                DELETE FROM Employees WHERE Last_Name = 'Bond';
                COMMIT;</code></pre>
            <pre><code class="language-output">
                1 row deleted.
                Commit complete.</code></pre>
            <pre class="line-numbers undefined"><code class="language-plsql">
                DELETE FROM Departments WHERE Department_ID = 15;
                COMMIT;</code></pre>
            <pre><code class="language-output">
                1 row deleted.
                Commit complete.
                </code></pre>
            <pre class="line-numbers undefined"><code class="language-plsql">
                EXECUTE emp_pkg.init_departments()
                
                </code></pre>
          </div>
          <div class="task" id="task-13-5">
            <p class="task-text" name="task-13-5"><b>Задание 5.</b> Поменяйте местами описание процедур и функций в пакете так, чтобы их имена шли в алфавитном порядке.</p>
            <ul>
              <li>Перепишите спецификацию пакета так, чтобы все элементы были перечислены в алфавитном порядке. Сохраните и скомпилируйте спецификацию пакета.</li>
              <li>Перепишите тело  пакета так, чтобы все элементы были перечислены в алфавитном порядке. Сохраните и скомпилируйте тело пакета. Зафиксируйте результат.</li>
              <li>Сделайте все необходимое, чтобы исправить ошибки компиляции. С чем они связаны? Выполните необходимые действия (подсказка: <code>forward declaration</code>).</li>
            </ul>
            <pre class="line-numbers undefined"><code class="language-plsql">CREATE OR REPLACE PACKAGE emp_pkg IS
  PRAGMA SERIALLY_REUSABLE;

  someVar NUMBER(10) := 20;


  PROCEDURE add_employee (
    firstName Employees.First_Name%TYPE
  ,  lastName Employees.Last_Name%TYPE
  ,      mail Employees.Email%TYPE
  ,       job Employees.Job_ID%TYPE          := 'SA_REP'
  ,       mgr Employees.Manager_ID%TYPE      := 145
  ,       sal Employees.Salary%TYPE          := 1000
  ,      comm Employees.Commission_PCT%TYPE  := 0
  ,     depID Employees.Department_ID%TYPE   := 30
  );

  PROCEDURE add_employee (
    firstName Employees.First_Name%TYPE
  ,  lastName Employees.Last_Name%TYPE
  ,     depID Employees.Department_ID%TYPE
  );

  PROCEDURE get_employee (
    id            Employees.Employee_ID%TYPE
  , jobID     OUT Employees.Job_ID%TYPE
  , empSalary OUT Employees.Salary%TYPE
  );

  FUNCTION get_employee (p_emp_id Employees.Employee_ID%TYPE)
  RETURN Employees%ROWTYPE;

  FUNCTION get_employee (p_family_name Employees.Last_Name%TYPE)
  RETURN Employees%ROWTYPE;

  PROCEDURE init_departments;

  PROCEDURE print_employee (emp Employees%ROWTYPE);
END emp_pkg;</code></pre>
            <pre><code class="language-output">Package EMP_PKG compiled</code></pre>
            <pre class="line-numbers undefined"><code class="language-plsql">CREATE OR REPLACE PACKAGE BODY emp_pkg IS
PRAGMA SERIALLY_REUSABLE;

  TYPE boolean_tab_type IS TABLE OF BOOLEAN INDEX BY BINARY_INTEGER;
  valid_departments boolean_tab_type;

  FUNCTION valid_deptid (depID Departments.Department_ID%TYPE) RETURN BOOLEAN;

  /*
    --- PUBLIC ---
  */
  PROCEDURE add_employee (
      firstName Employees.First_Name%TYPE
    ,  lastName Employees.Last_Name%TYPE
    ,      mail Employees.Email%TYPE
    ,       job Employees.Job_ID%TYPE          := 'SA_REP'
    ,       mgr Employees.Manager_ID%TYPE      := 145
    ,       sal Employees.Salary%TYPE          := 1000
    ,      comm Employees.Commission_PCT%TYPE  := 0
    ,     depID Employees.Department_ID%TYPE   := 30
    ) IS
  BEGIN
    IF valid_deptid(depID) THEN
      INSERT INTO Employees (
        Employee_ID
      , First_Name
      , Last_Name
      , Email
      , Hire_Date
      , Job_ID
      , Manager_ID
      , Salary
      , Commission_PCT
      , Department_ID
      )
      VALUES (
        Employees_Seq.NEXTVAL -- Employee_ID
      , firstName
      , lastName
      , mail
      , TRUNC(SYSDATE) -- Hire_Date
      , job
      , mgr
      , sal
      , comm
      , depID
      );
    ELSE
      DBMS_OUTPUT.PUT_LINE(
        'Error: cannot add an employee to a nonexistent department #' || depID || '.'
      );
    END IF;
  END add_employee;

  PROCEDURE add_employee (
      firstName Employees.First_Name%TYPE
    ,  lastName Employees.Last_Name%TYPE
    ,     depID Employees.Department_ID%TYPE
    ) IS
    email Employees.Email%TYPE := UPPER(SUBSTR(firstName, 1, 1)) || UPPER(SUBSTR(lastName, 1, 7));
  BEGIN
    add_employee(firstName, lastName, mail => email, depID => depID);
  END add_employee;

  PROCEDURE get_employee (
      id            Employees.Employee_ID%TYPE,
      jobID     OUT Employees.Job_ID%TYPE,
      empSalary OUT Employees.Salary%TYPE
    ) IS
  BEGIN
    SELECT Job_ID, Salary
    INTO   jobID,  empSalary
    FROM Employees
    WHERE Employee_ID = id;

  EXCEPTION
    WHEN NO_DATA_FOUND THEN
      DBMS_OUTPUT.PUT_LINE('get_employee error:');
      DBMS_OUTPUT.PUT_LINE(
           '  could not get Employee information from'
        || ' get_employee(' || id || ', jobID, empSalary).'
      );
      DBMS_OUTPUT.PUT_LINE('  There is no employee with ID ' || id || '.');
  END get_employee;

  FUNCTION get_employee (p_emp_id Employees.Employee_ID%TYPE)
  RETURN Employees%ROWTYPE IS
    emp Employees%ROWTYPE;
  BEGIN
    SELECT *
    INTO   emp
    FROM Employees
    WHERE Employee_ID = p_emp_id;

    RETURN emp;
  END;

  FUNCTION get_employee (p_family_name Employees.Last_Name%TYPE)
  RETURN Employees%ROWTYPE IS
    emp Employees%ROWTYPE;
  BEGIN
    SELECT *
    INTO   emp
    FROM Employees
    WHERE Last_Name = p_family_name;

    RETURN emp;
  END;

  PROCEDURE init_departments IS BEGIN
    DBMS_OUTPUT.PUT_LINE(someVar || ' -- some var');
    FOR row IN (SELECT Department_ID FROM Departments) LOOP
      valid_departments(row.Department_ID) := TRUE;
    END LOOP;
  END;

  PROCEDURE print_employee (emp Employees%ROWTYPE) IS BEGIN
    DBMS_OUTPUT.PUT_LINE(
         'Emp#' || emp.Employee_ID || ': '
      || emp.First_Name || ' ' || emp.Last_Name
      || ', depID is '  || emp.Department_ID
      || ', job is '    || emp.Job_ID
      || ', salary is ' || emp.Salary || '.'
    );
  END;


  /*
    --- PRIVATE ---
  */
  FUNCTION valid_deptid (depID Departments.Department_ID%TYPE)
  RETURN BOOLEAN IS 
  BEGIN
    IF valid_departments(depID) THEN RETURN TRUE;
    ELSE RETURN FALSE; END IF;
  EXCEPTION
    WHEN OTHERS THEN RETURN FALSE;
  END valid_deptid;

BEGIN
  init_departments();
END emp_pkg;
/</code></pre>
            <pre><code class="language-output">
                Package Body EMP_PKG compiled
                </code></pre>
            <p>Если мы закомментируем строчку (с <code>forward declaration</code>):</p>
            <pre class="line-numbers undefined"><code class="language-plsql">FUNCTION valid_deptid (depID Departments.Department_ID%TYPE) RETURN BOOLEAN;</code></pre>
            <p>то получим следующую ошибку:</p><img src="../img/13-5-error.png" width="80%"/>
          </div>
        </div>
      </div>
    </div>
    <script src="./../js/prism.js"></script>
    <script src="./../js/setup.js"></script>
    <script src="./../js/main.js"></script>
  </body>
</html>