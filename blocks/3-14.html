<!DOCTYPE htmls>
<html lang="ru">
  <head>
    <title>Доп. задание 3.14</title>
    <meta charset="UTF-8"/>
    <link rel="icon" href="../img/icons/database.png"/><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link rel="stylesheet" href="../css/main.css"/>
  </head>
  <body>
    <nav id="menu"><a class="element" id="menu-switch">
        <div class="icon-part"><img class="icon" src="../img/icons/menu.png"/></div>
        <div class="text-part"></div></a><a class="element" href="../index.html">
        <div class="icon-part"><img class="icon" src="../img/icons/home.png"/></div>
        <div class="text-part">На главную</div></a><a class="element link" href="https://github.com/Ruminat/PL-SQL-labs">
        <div class="icon-part"><img class="icon" src="../img/icons/github.png"/></div>
        <div class="text-part">GitHub</div></a>
    </nav>
    <div id="main">
      <div class="labs">
        <div class="labs">
          <div class="header">
            <h1>Дополнительное задание 3.14</h1>
          </div>
        </div>
        <h2>Постановка задачи</h2>
        <p class="task-text">Создать процедуру, которая находит все пути между двумя городами. Имена городов — параметры процедуры. Расстояния между городами заданы в таблице <code>Paths</code>. Имена городов уникальны. Скрипт на создание таблицы <code>paths.sql</code> находится в папке курса на <code>Public2</code>.</p><row class="aligment-center"><table class="table table-SQL table-bordered table-hover table-sm"><thead class="thead-dark"><tr><th>AID</th><th>ACITY</th><th>BID</th><th>BCITY</th><th>DIST</th></tr></thead><tbody><tr><td>1</td><td>Moscow</td><td>2</td><td>Kazan</td><td>2</td></tr><tr><td>1</td><td>Moscow</td><td>3</td><td>Tula</td><td>4</td></tr><tr><td>1</td><td>Moscow</td><td>4</td><td>Sochi</td><td>7</td></tr><tr><td>1</td><td>Moscow</td><td>6</td><td>Omsk</td><td>5</td></tr><tr><td>2</td><td>Kazan</td><td>4</td><td>Sochi</td><td>6</td></tr><tr><td>2</td><td>Kazan</td><td>7</td><td>Vologda</td><td>8</td></tr><tr><td>2</td><td>Kazan</td><td>5</td><td>Pskov</td><td>3</td></tr><tr><td>3</td><td>Tula</td><td>6</td><td>Omsk</td><td>6</td></tr><tr><td>4</td><td>Sochi</td><td>6</td><td>Omsk</td><td>1</td></tr><tr><td>4</td><td>Sochi</td><td>7</td><td>Vologda</td><td>6</td></tr><tr><td>5</td><td>Pskov</td><td>7</td><td>Vologda</td><td>7</td></tr><tr><td>6</td><td>Omsk</td><td>7</td><td>Vologda</td><td>6</td></tr></tbody></table></row>
        <p>Программа должна предусматривать обработку исключений.</p>
        <p>Пример представления результата:</p>
        <pre><code class="language-output">
            Маршруты Pskov — Vologda 
              Pskov Kazan Moscow Omsk Sochi Vologda       Длина маршрута — 17
              Pskov Kazan Moscow Omsk Vologda             ...................
              Pskov Kazan Moscow Sochi Omsk Vologda 
              Pskov Kazan Moscow Sochi Vologda 
              Pskov Kazan Moscow Tula Omsk Sochi Vologda 
              Pskov Kazan Moscow Tula Omsk Vologda 
              Pskov Kazan Sochi Moscow Omsk Vologda 
              Pskov Kazan Sochi Moscow Tula Omsk Vologda 
              Pskov Kazan Sochi Vologda                   ...................
              Pskov Kazan Vologda                         Длина маршрута — 11
            Всего 10 вариантов маршрута
            </code></pre>
        <h2>Решение</h2>
        <pre class="line-numbers undefined"><code class="language-plsql">-- Создание процедуры.
CREATE OR REPLACE PROCEDURE
  dop_3_14 (fromCity Paths.Acity%TYPE, toCity Paths.Bcity%TYPE) IS
  
  TYPE passedCitiesTable IS TABLE OF BOOLEAN
    INDEX BY PLS_INTEGER;

  TYPE reachableCitiesTable IS TABLE OF Paths.Dist%TYPE
    INDEX BY PLS_INTEGER;

  TYPE citiesTable IS TABLE OF reachableCitiesTable
    INDEX BY PLS_INTEGER;

  cities citiesTable;       -- Таблица дистанций между городами.
  passed passedCitiesTable; -- Таблица городов, которые мы уже проехали.
  -- Таблица всех путей от города fromCity к toCity,
  -- в каждом из путей хранятся лишь промежуточные города.
  allPaths citiesTable;


  fromID Paths.AID%TYPE; -- ID города, из которого выезжаем.
  toID   Paths.BID%TYPE; -- ID города, в который приезжаем.
  -- Сообщение об ошибке.
  PROCEDURE error (message VARCHAR2) IS BEGIN
    DBMS_OUTPUT.PUT_LINE('Dop_3_14(''' || fromCity || ''', ''' || toCity || ''') error:');
    DBMS_OUTPUT.PUT_LINE('  ' || message);
  END;
BEGIN
  FOR row IN (SELECT * FROM Paths) LOOP
    -- Если в таблице Paths есть строка с NULL'овым значением.
    IF   row.AID   IS NULL OR row.BID   IS NULL
      OR row.Acity IS NULL OR row.Bcity IS NULL OR row.Dist IS NULL
    THEN
      error(
           'there is a NULL in the Paths table row: '
        || 'AID: '   || NVL(TO_CHAR(row.AID),   '(null)') || ', '
        || 'Acity: ' || NVL(row.Acity,          '(null)') || ', '
        || 'BID: '   || NVL(TO_CHAR(row.BID),   '(null)') || ', '
        || 'Bcity: ' || NVL(row.Bcity,          '(null)') || ', '
        || 'Dist: '  || NVL(TO_CHAR(row.Dist),  '(null)') || '.'
      );
    RETURN; END IF;

    -- Сопоставляем заданным городам их ID (при наличии).
    IF fromID IS NULL THEN
      IF row.Acity = fromCity THEN fromID := row.AID; END IF;
      IF row.Bcity = fromCity THEN fromID := row.BID; END IF;
    END IF;
    IF toID   IS NULL THEN
      IF row.Acity = toCity   THEN toID   := row.AID; END IF;
      IF row.Bcity = toCity   THEN toID   := row.BID; END IF;
    END IF;

    -- Пути работют в обе стороны, то есть AID <-> BID.
    cities(row.AID)(row.BID) := row.Dist;
    cities(row.BID)(row.AID) := row.Dist;
  END LOOP;

  -- Проверяем, есть ли вообще города в таблице Paths.
  IF cities.FIRST IS NULL THEN
    error('there are no cities in the Paths table');
    RETURN; END IF;
  -- Проверяем, есть ли заданные города в таблице Paths
  IF fromID IS NULL THEN
    error('there is no such city as ' || fromCity || ' in Paths table.');
    RETURN; END IF;
  IF toID IS NULL THEN
    error('there is no such city as ' || toCity   || ' in Paths table.');
    RETURN; END IF;



  DBMS_OUTPUT.PUT_LINE('Made it to the end.');

  EXCEPTION
    WHEN OTHERS THEN
      error('something went wrong...');
END dop_3_14;
/


-- Вызов процедуры.
BEGIN
  dop_3_14('Pskov', 'Vologda');
END;</code></pre>
      </div>
    </div>
    <script src="../js/prism.js"></script>
    <script src="../js/setup.js"></script>
    <script src="../js/main.js"></script>
  </body>
</html>